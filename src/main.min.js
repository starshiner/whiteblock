var gameObj=gameObj||{};gameObj.gameWidth=365;gameObj.gameHeight=525;gameObj.onStartGame=false;gameObj.score=0;gameObj.musicSwitch=true;gameObj.musicNum=0;gameObj.musicArr=new Array();gameObj.musicArr[0]=[1,2,3,1,1,2,3,1,3,4,5,3,4,5,5,6,5,4,3,1,5,6,5,4,3,1,2,5,1,0,2,5,1,0];gameObj.musicArr[1]=[3,5,2,1,5,4,3,3,3,4,5,6,5,3,5,2,1,5,4,3,5,5,6,0,1,0,1,2,5,5,0,6,5,3,5,1,6,1,2,1,0,5,3,5,2,1,5,4,3,5,5,6,0,1,1,0];gameObj.musicArr[2]=[5,1,0,1,5,5,1,0,1,5,5,1,0,1,1,1,6,6,5,5,1,0,1,5,5,3,2,2,1,5,1,0,1,6,6,6,1,6,5];gameObj.musicArr[3]=[3,5,1,5,6,6,5,3,3,5,5,3,5,6,1,2,1,5,3,2,5,3,3,5,1,5,6,1,2,1,5,3,5,1,6,3,2,3,5,3,2,1,1];gameObj.musicArr[4]=[8,8,8,8];gameObj.musicArr[5]=[9,9,9,9];gameObj.music=function(i,game){if(gameObj.musicSwitch){var musicA=gameObj.musicArr[i];game.sound.stopAll();gameObj.musicI[musicA[(gameObj.musicNum++)%musicA.length]].play()}};gameObj.game=new Phaser.Game(gameObj.gameWidth,gameObj.gameHeight,Phaser.AUTO,"canvas");gameObj.State_boot=function(){this.preload=function(){if(!this.game.device.desktop){this.scale.scaleMode=Phaser.ScaleManager.EXACT_FIT;this.scale.forcePortrait=true;this.scale.refresh()}else{this.game.scale.pageAlignVertically=true;this.game.scale.pageAlignHorizontally=true}if(window.localStorage){if(localStorage.getItem("username_1")){gameObj.username=localStorage.getItem("username_1")}else{gameObj.username=Date.parse(new Date());localStorage.setItem("username_1",gameObj.username);localStorage.setItem("gameData_classic",0);localStorage.setItem("gameData_arcade",0);localStorage.setItem("gameData_zen",0);localStorage.setItem("gameData_relay",0)}}else{alert("您的浏览器不支持localStorage,请升级浏览器")}this.game.stage.backgroundColor="#fff";this.game.load.image("loading","assets/preloader.gif")};this.create=function(){this.game.state.start("preload")}};gameObj.State_preload=function(){this.preload=function(){this.lable=this.game.add.text(gameObj.gameWidth/2,170,"loading...",{font:"30px Arial",fill:"#000"});this.lable.anchor.set(0.5);this.preloadSprite=this.game.add.sprite(70,200,"loading");this.game.load.setPreloadSprite(this.preloadSprite);this.game.load.spritesheet("white_block","assets/whiteblock.png",92,132,2);this.game.load.spritesheet("black_block","assets/blackblock.png",92,132,3);this.game.load.spritesheet("start_block","assets/startblock.png",92,132,2);this.game.load.spritesheet("yellow_block","assets/yellowblock.png",92,132,2);this.game.load.spritesheet("green_block","assets/greenblock.png",92,132,2);this.game.load.image("check_line","assets/checkline.png");this.game.load.image("rate_line","assets/rate.jpg");this.game.load.image("black_bg","assets/blackbg.png");this.game.load.image("white_bg","assets/whitebg.png");this.game.load.audio("m0","assets/0.ogg");this.game.load.audio("m1","assets/1.ogg");this.game.load.audio("m2","assets/2.ogg");this.game.load.audio("m3","assets/3.ogg");this.game.load.audio("m4","assets/4.ogg");this.game.load.audio("m5","assets/5.ogg");this.game.load.audio("m6","assets/6.ogg");this.game.load.audio("mf","assets/f.ogg");this.game.load.audio("over","assets/success.wav")};this.create=function(){gameObj.musicI=new Array();gameObj.musicI[0]=this.game.add.audio("m0");gameObj.musicI[1]=this.game.add.audio("m1");gameObj.musicI[2]=this.game.add.audio("m2");gameObj.musicI[3]=this.game.add.audio("m3");gameObj.musicI[4]=this.game.add.audio("m4");gameObj.musicI[5]=this.game.add.audio("m5");gameObj.musicI[6]=this.game.add.audio("m6");gameObj.musicI[8]=this.game.add.audio("mf");gameObj.musicI[9]=this.game.add.audio("over");this.game.state.start("homepage")}};gameObj.State_homepage=function(){this.preload=function(){this.game.stage.backgroundColor="#fff"};this.create=function(){this.addMenuBtn(0,0,"black_bg","经典","classic");this.addMenuBtn(184,0,"white_bg","街机","arcade");this.addMenuBtn(0,176,"white_bg","禅","zen");this.addMenuBtn(184,176,"black_bg","接力","relay");if(gameObj.musicSwitch){this.addMenuBtn(0,352,"black_bg","音效开","music")}else{this.addMenuBtn(0,352,"black_bg","音效关","music")}this.addMenuBtn(184,352,"white_bg","排行榜","showrank")};this.addMenuBtn=function(x,y,bg,name,to){var color=null;if(bg=="black_bg"){color="#fff"}else{color="#000"}var objBtn=new Array();objBtn[to]=this.game.add.sprite(x,y,bg);objBtn[to].inputEnabled=true;objBtn[to].objText=this.game.add.text(x+91,y+87,name,{font:"35px Arial ",fill:color});objBtn[to].objText.anchor.set(0.5);objBtn[to].events.onInputDown.add(function(){if(to!="music"){gameObj.game.state.start(to)}else{if(gameObj.musicSwitch){objBtn["music"].objText.text="音效关";gameObj.musicSwitch=false}else{objBtn["music"].objText.text="音效开";gameObj.musicSwitch=true}}},this)}};gameObj.State_showrank=function(){this.preload=function(){this.game.stage.backgroundColor="#000"};this.create=function(){gameObj.onShowRank=true;for(var i=0;i<6;i++){for(var j=0;j<4;j++){this.spt=this.game.add.sprite(92*j+1,88*i+1,"white_bg");this.spt.scale.set(0.472)}}this.lable_score=this.game.add.text(12,5,"←",{font:"60px Arial",fill:"#f00"});this.lable_score.inputEnabled=true;this.lable_score.events.onInputDown.add(function(){gameObj.onShowRank=false;
gameObj.game.state.start("homepage")},this);this.game.add.text(110,15,"排",{font:"50px Arial",fill:"#000"});this.game.add.text(205,15,"行",{font:"50px Arial",fill:"#000"});this.game.add.text(295,15,"榜",{font:"50px Arial",fill:"#000"});this.game.add.text(15,110,"模式",{font:"30px Arial",fill:"#000"});this.game.add.text(115,105,"个人",{font:"20px Arial",fill:"#000"});this.game.add.text(105,125,"最高分",{font:"20px Arial",fill:"#000"});this.game.add.text(208,105,"玩家",{font:"20px Arial",fill:"#000"});this.game.add.text(207,125,"名次",{font:"20px Arial",fill:"#000"});this.game.add.text(300,105,"玩家",{font:"20px Arial",fill:"#000"});this.game.add.text(290,125,"最高分",{font:"20px Arial",fill:"#000"});this.game.add.text(15,200,"经典",{font:"30px Arial",fill:"#000"});this.game.add.text(15,290,"街机",{font:"30px Arial",fill:"#000"});this.game.add.text(15,377,"禅",{font:"30px Arial",fill:"#000"});this.game.add.text(15,467,"接力",{font:"30px Arial",fill:"#000"});gameObj.dataArr=new Array();this.gameNameArr=["classic","arcade","zen","relay"];for(var i=0;i<4;i++){gameObj.dataArr[i]=new Array();for(var j=0;j<3;j++){gameObj.dataArr[i][j]=this.game.add.text(93*(j+1)+43,186+89*i+35,"-",{font:"20px Arial",fill:"#000"});gameObj.dataArr[i][j].anchor.set(0.5)}}for(var i=0;i<this.gameNameArr.length;i++){gameObj.dataArr[i][0].text=localStorage.getItem("gameData_"+this.gameNameArr[i])}var xhr=new xhrFactory();var pm0={},pm1={},pm2={},pm3={};var pm=["pm0","pm1","pm2","pm3"];for(var i=0;i<4;i++){this.getDate(pm,localStorage.getItem("gameData_"+this.gameNameArr[i]),i,xhr)}};this.getDate=function(pm,score,item,xhr){var tmp={name:pm[item],url:"http://xingguang123.sinaapp.com/whiteblock.php",data:{username:gameObj.username,score:score,item:item},dataType:"jsonp",success:function(data){if(gameObj.onShowRank){gameObj.dataArr[item][1].text=data[1];gameObj.dataArr[item][2].text=data[0]}}};switch(item){case 0:pm0=tmp;break;case 1:pm1=tmp;break;case 2:pm2=tmp;break;case 3:pm3=tmp;break}xhr.ajax(tmp)}};gameObj.State_classic=function(){this.preload=function(){this.game.stage.backgroundColor="#fff"};this.create=function(){gameObj.gameMode="经典模式";gameObj.gameModeCode="classic";gameObj.musicNum=0;gameObj.score=0;gameObj.rdmMusic=this.getRandom(0,3);gameObj.nextFloor=1;this.onStartGame=false;this.blockLine=7;this.gate=1;this.gateF=5;this.topScore=50;this.lable_score=this.game.add.text(150,25,0,{font:"45px Arial",fill:"#f00"});this.lable_rate=this.game.add.sprite(0,0,"rate_line");this.lable_rate.scale.x=0;this.ground=this.game.add.sprite(0,526,"check_line");this.game.physics.enable([this.ground],Phaser.Physics.ARCADE);gameObj.blockArr=new Array();this.initGame()};this.update=function(){if(this.onStartGame){this.lable_score.text=parseInt((this.game.time.prevTime-this.startTime)/10)/100;this.lable_rate.scale.x=gameObj.score/this.topScore;for(var m=0;m<gameObj.blockArr.length;m++){if(gameObj.blockArr[m].previousPosition.y>gameObj.gameHeight-50){if(gameObj.blockArr[m].live){gameObj.blockArr[m].play("out");gameObj.music(4,this.game);this.game.paused=true;setTimeout(function(){gameObj.game.paused=false;gameObj.gameResult=false;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")},200)}else{if(gameObj.blockArr[m].previousPosition.y>gameObj.gameHeight+70){gameObj.blockArr[m].kill();gameObj.blockArr.splice(m,1)}}}}}this.game.world.bringToTop(this.lable_score);this.game.world.bringToTop(this.lable_rate)};this.initGame=function(){var rdm1=this.getRandom(0,3);var rdm2=this.getRandom(0,3);var rdm3=this.getRandom(0,3);var rdm4=this.getRandom(0,3);var rdm5=this.getRandom(0,3);var rdm6=this.getRandom(0,3);for(var i=0;i<4;i++){this.addOneBlock("yellow_block",i,0)}this.addOneBlock("start_block",rdm1,1);for(var i=0;i<4;i++){if(i!=rdm1){this.addOneBlock("white_block",i,1)}}for(var i=2;i<7;i++){this.addOneLineBlock(i)}};this.addOneBlock=function(name,x,y){var obj=this.game.make.sprite(46+91*x,-(66+131*y),name);obj.live=true;obj.floor=y;obj.anchor.set(0.5);this.ground.addChild(obj);obj.animations.add("live",[0],1,false);obj.animations.add("dead",[1],1,false);if(name=="black_block"){gameObj.blockArr[gameObj.blockArr.length]=obj;obj.animations.add("out",[2],1,false)}obj.animations.play("live");obj.inputEnabled=true;obj.events.onInputDown.removeAll();obj.events.onInputDown.add(function(){if(obj.floor==gameObj.nextFloor){if(name=="black_block"){if(this.onStartGame&&obj.live){obj.live=false;gameObj.music(gameObj.rdmMusic,this.game);obj.animations.play("dead");obj.scale.set(0.85);this.game.add.tween(obj.scale).to({x:1,y:1},200,null,true,0,0,false);this.clickBlack()}}else{if(name=="white_block"){if(this.onStartGame){gameObj.music(4,this.game);obj.animations.play("dead");this.clickWhite()}}else{if(name=="start_block"){if(!this.onStartGame){gameObj.music(gameObj.rdmMusic,this.game);obj.animations.play("dead");obj.scale.set(0.85);this.game.add.tween(obj.scale).to({x:1,y:1},200,null,true,0,0,false);this.startTime=this.game.time.prevTime;this.onStartGame=true;this.startGame()}}}}gameObj.nextFloor++
}},this)};this.addBlock=function(){this.addOneLineBlock(this.blockLine++)};this.addOneLineBlock=function(y){var rdm=this.getRandom(0,3);this.addOneBlock("black_block",rdm,y);for(var i=0;i<4;i++){if(i!=rdm){this.addOneBlock("white_block",i,y)}}};this.startGame=function(){gameObj.score++;var tmpy=this.ground.y+131;this.game.add.tween(this.ground).to({y:tmpy},200,null,true,0,0,false)};this.clickBlack=function(){if(gameObj.score<this.topScore-5){this.addBlock()}else{for(var i=0;i<4;i++){this.addOneBlock("green_block",i,this.blockLine)}this.blockLine++}gameObj.score++;if(gameObj.score==this.topScore){this.game.paused=true;gameObj.music(5,this.game);gameObj.gameScore=parseInt((this.game.time.prevTime-this.startTime)/10)/100;setTimeout(function(){gameObj.game.paused=false;gameObj.gameResult=true;gameObj.game.state.start("gameover")},200)}var gy=this.ground.y;if((gy-526)%131!=0){var gy=(Math.floor((gy-526)/131)+1)*131+526}var tmpy=gy+131;this.game.add.tween(this.ground).to({y:tmpy},200,null,true,0,0,false)};this.clickWhite=function(){this.game.paused=true;gameObj.music(4,this.game);setTimeout(function(){gameObj.game.paused=false;gameObj.gameResult=false;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")},200)};this.getRandom=function(a,b){return Math.floor(Math.random()*(b+1))+a}};gameObj.State_arcade=function(){this.preload=function(){this.game.stage.backgroundColor="#fff"};this.create=function(){gameObj.gameMode="街机模式";gameObj.gameModeCode="arcade";gameObj.musicNum=0;gameObj.score=0;gameObj.rdmMusic=this.getRandom(0,3);gameObj.nextFloor=1;this.onStartGame=false;this.blockLine=7;this.gate=1;this.gateF=5;this.lable_score=this.game.add.text(gameObj.gameWidth/2,25,0,{font:"45px Arial",fill:"#f00"});this.lable_score.anchor.set(0.5);this.groundV=200;this.groundI=10;this.ground=this.game.add.sprite(0,526,"check_line");this.game.physics.enable([this.ground],Phaser.Physics.ARCADE);gameObj.blockArr=new Array();this.initGame()};this.update=function(){if(this.onStartGame){this.ground.body.velocity.y=this.groundV;if(gameObj.score>=this.gateF*this.gate){this.gate++;this.groundV+=this.groundI}for(var m=0;m<gameObj.blockArr.length;m++){if(gameObj.blockArr[m].previousPosition.y>gameObj.gameHeight-50){if(gameObj.blockArr[m].live){gameObj.blockArr[m].play("out");gameObj.music(4,this.game);this.game.paused=true;setTimeout(function(){gameObj.game.paused=false;gameObj.gameResult=true;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")},200)}else{if(gameObj.blockArr[m].previousPosition.y>gameObj.gameHeight+70){gameObj.blockArr[m].kill();gameObj.blockArr.splice(m,1)}}}}}this.lable_score.text=gameObj.score;this.game.world.bringToTop(this.lable_score)};this.initGame=function(){var rdm1=this.getRandom(0,3);var rdm2=this.getRandom(0,3);var rdm3=this.getRandom(0,3);var rdm4=this.getRandom(0,3);var rdm5=this.getRandom(0,3);var rdm6=this.getRandom(0,3);for(var i=0;i<4;i++){this.addOneBlock("yellow_block",i,0)}this.addOneBlock("start_block",rdm1,1);for(var i=0;i<4;i++){if(i!=rdm1){this.addOneBlock("white_block",i,1)}}for(var i=2;i<7;i++){this.addOneLineBlock(i)}};this.addOneBlock=function(name,x,y){var obj=this.game.make.sprite(46+91*x,-(66+131*y),name);obj.live=true;obj.anchor.set(0.5);this.ground.addChild(obj);obj.animations.add("live",[0],1,false);obj.animations.add("dead",[1],1,false);if(name=="black_block"){gameObj.blockArr[gameObj.blockArr.length]=obj;obj.animations.add("out",[2],1,false)}obj.floor=y;obj.animations.play("live");obj.inputEnabled=true;obj.events.onInputDown.removeAll();obj.events.onInputDown.add(function(){if(obj.floor==gameObj.nextFloor){if(name=="black_block"){if(this.onStartGame&&obj.live){obj.live=false;gameObj.music(gameObj.rdmMusic,this.game);obj.animations.play("dead");obj.scale.set(0.85);this.game.add.tween(obj.scale).to({x:1,y:1},200,null,true,0,0,false);this.clickBlack()}}else{if(name=="white_block"){if(this.onStartGame){gameObj.music(4,this.game);obj.animations.play("dead");this.clickWhite()}}else{if(name=="start_block"){if(!this.onStartGame){gameObj.music(gameObj.rdmMusic,this.game);obj.animations.play("dead");obj.scale.set(0.85);this.game.add.tween(obj.scale).to({x:1,y:1},200,null,true,0,0,false);this.onStartGame=true;this.startGame()}}}}gameObj.nextFloor++}},this)};this.addBlock=function(){this.addOneLineBlock(this.blockLine++)};this.addOneLineBlock=function(y){var rdm=this.getRandom(0,3);this.addOneBlock("black_block",rdm,y);for(var i=0;i<4;i++){if(i!=rdm){this.addOneBlock("white_block",i,y)}}};this.startGame=function(){gameObj.score++};this.clickBlack=function(){this.addBlock();gameObj.score++};this.clickWhite=function(){this.game.paused=true;setTimeout(function(){gameObj.game.paused=false;gameObj.gameResult=true;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")},200)};this.getRandom=function(a,b){return Math.floor(Math.random()*(b+1))+a}};gameObj.State_zen=function(){this.preload=function(){this.game.stage.backgroundColor="#fff"};this.create=function(){gameObj.gameMode="禅模式";
gameObj.gameModeCode="zen";gameObj.musicNum=0;gameObj.score=0;gameObj.rdmMusic=this.getRandom(0,3);gameObj.nextFloor=1;this.onStartGame=false;this.blockLine=7;this.endTime=10000;this.lable_score=this.game.add.text(gameObj.gameWidth/2,30,0,{font:"45px Arial",fill:"#f00"});this.lable_score.anchor.set(0.5);this.lable_rate=this.game.add.sprite(0,0,"rate_line");this.lable_rate.scale.x=1;this.ground=this.game.add.sprite(0,526,"check_line");this.game.physics.enable([this.ground],Phaser.Physics.ARCADE);gameObj.blockArr=new Array();this.initGame()};this.update=function(){if(this.onStartGame){this.lable_score.text=gameObj.score;if(this.endTime-(this.game.time.prevTime-this.startTime)<=0){gameObj.music(5,this.game);gameObj.gameResult=true;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")}this.lable_rate.scale.x=(this.endTime-(this.game.time.prevTime-this.startTime))/this.endTime;for(var m=0;m<gameObj.blockArr.length;m++){if(gameObj.blockArr[m].previousPosition.y>gameObj.gameHeight-50){if(gameObj.blockArr[m].live){gameObj.blockArr[m].play("out");gameObj.music(4,this.game);this.game.paused=true;setTimeout(function(){gameObj.game.paused=false;gameObj.gameResult=false;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")},200)}else{if(gameObj.blockArr[m].previousPosition.y>gameObj.gameHeight+70){gameObj.blockArr[m].kill();gameObj.blockArr.splice(m,1)}}}}}this.game.world.bringToTop(this.lable_score);this.game.world.bringToTop(this.lable_rate)};this.initGame=function(){var rdm1=this.getRandom(0,3);var rdm2=this.getRandom(0,3);var rdm3=this.getRandom(0,3);var rdm4=this.getRandom(0,3);var rdm5=this.getRandom(0,3);var rdm6=this.getRandom(0,3);for(var i=0;i<4;i++){this.addOneBlock("yellow_block",i,0)}this.addOneBlock("start_block",rdm1,1);for(var i=0;i<4;i++){if(i!=rdm1){this.addOneBlock("white_block",i,1)}}for(var i=2;i<7;i++){this.addOneLineBlock(i)}};this.addOneBlock=function(name,x,y){var obj=this.game.make.sprite(46+91*x,-(66+131*y),name);obj.live=true;obj.anchor.set(0.5);this.ground.addChild(obj);obj.animations.add("live",[0],1,false);obj.animations.add("dead",[1],1,false);if(name=="black_block"){gameObj.blockArr[gameObj.blockArr.length]=obj;obj.animations.add("out",[2],1,false)}obj.floor=y;obj.animations.play("live");obj.inputEnabled=true;obj.events.onInputDown.removeAll();obj.events.onInputDown.add(function(){if(obj.floor==gameObj.nextFloor){if(name=="black_block"){if(this.onStartGame&&obj.live){obj.live=false;gameObj.music(gameObj.rdmMusic,this.game);obj.animations.play("dead");obj.scale.set(0.85);this.game.add.tween(obj.scale).to({x:1,y:1},200,null,true,0,0,false);this.clickBlack()}}else{if(name=="white_block"){if(this.onStartGame){gameObj.music(4,this.game);obj.animations.play("dead");this.clickWhite()}}else{if(name=="start_block"){if(!this.onStartGame){gameObj.music(gameObj.rdmMusic,this.game);obj.animations.play("dead");obj.scale.set(0.85);this.game.add.tween(obj.scale).to({x:1,y:1},200,null,true,0,0,false);this.startTime=this.game.time.prevTime;this.onStartGame=true;this.startGame()}}}}gameObj.nextFloor++}},this)};this.addBlock=function(){this.addOneLineBlock(this.blockLine++)};this.addOneLineBlock=function(y){var rdm=this.getRandom(0,3);this.addOneBlock("black_block",rdm,y);for(var i=0;i<4;i++){if(i!=rdm){this.addOneBlock("white_block",i,y)}}};this.startGame=function(){gameObj.score++;var tmpy=this.ground.y+131;this.game.add.tween(this.ground).to({y:tmpy},200,null,true,0,0,false)};this.clickBlack=function(){this.addBlock();gameObj.score++;var gy=this.ground.y;console.log((gy-526)%131);if((gy-526)%131!=0){var gy=(Math.floor((gy-526)/131)+1)*131+526}var tmpy=gy+131;console.log("++++++"+(tmpy-526)%131);this.game.add.tween(this.ground).to({y:tmpy},200,null,true,0,0,false)};this.clickWhite=function(){this.game.paused=true;gameObj.music(4,this.game);setTimeout(function(){gameObj.game.paused=false;gameObj.gameResult=false;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")},200)};this.getRandom=function(a,b){return Math.floor(Math.random()*(b+1))+a}};gameObj.State_relay=function(){this.preload=function(){this.game.stage.backgroundColor="#fff"};this.create=function(){gameObj.gameMode="接力模式";gameObj.gameModeCode="relay";gameObj.musicNum=0;gameObj.score=0;gameObj.rdmMusic=this.getRandom(0,3);gameObj.nextFloor=1;this.onStartGame=false;this.blockLine=7;this.endTime=10000;this.blockI=30;this.blockA=10;this.timeI=10000;this.gate=1;this.blockC=0;this.lable_score=this.game.add.text(150,30,0,{font:"45px Arial",fill:"#f00"});this.lable_rate=this.game.add.sprite(0,0,"rate_line");this.lable_rate.scale.x=0;this.ground=this.game.add.sprite(0,526,"check_line");this.game.physics.enable([this.ground],Phaser.Physics.ARCADE);gameObj.blockArr=new Array();this.initGame()};this.update=function(){if(this.onStartGame){if((this.endTime-(this.game.time.prevTime-this.startTime))>0){this.lable_score.text=(this.endTime-(this.game.time.prevTime-this.startTime))/1000}else{this.lable_score.text=0}this.lable_rate.scale.x=(gameObj.score-this.blockC)/(this.blockI+this.blockA*(this.gate-1));
if((gameObj.score-this.blockC)>=(this.blockI+this.blockA*(this.gate-1))){this.endTime+=this.timeI;this.gate++;this.blockC=this.blockC+this.blockA*(this.gate+1)}if(this.endTime-(this.game.time.prevTime-this.startTime)<=0.001){gameObj.gameResult=true;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")}for(var m=0;m<gameObj.blockArr.length;m++){if(gameObj.blockArr[m].previousPosition.y>gameObj.gameHeight-50){if(gameObj.blockArr[m].live){gameObj.blockArr[m].play("out");gameObj.music(4,this.game);this.game.paused=true;setTimeout(function(){gameObj.game.paused=false;gameObj.gameResult=false;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")},200)}else{if(gameObj.blockArr[m].previousPosition.y>gameObj.gameHeight+70){gameObj.blockArr[m].kill();gameObj.blockArr.splice(m,1)}}}}}this.game.world.bringToTop(this.lable_score);this.game.world.bringToTop(this.lable_rate)};this.initGame=function(){var rdm1=this.getRandom(0,3);var rdm2=this.getRandom(0,3);var rdm3=this.getRandom(0,3);var rdm4=this.getRandom(0,3);var rdm5=this.getRandom(0,3);var rdm6=this.getRandom(0,3);for(var i=0;i<4;i++){this.addOneBlock("yellow_block",i,0)}this.addOneBlock("start_block",rdm1,1);for(var i=0;i<4;i++){if(i!=rdm1){this.addOneBlock("white_block",i,1)}}for(var i=2;i<7;i++){this.addOneLineBlock(i)}};this.addOneBlock=function(name,x,y){var obj=this.game.make.sprite(46+91*x,-(66+131*y),name);obj.live=true;obj.anchor.set(0.5);obj.floor=y;this.ground.addChild(obj);obj.animations.add("live",[0],1,false);obj.animations.add("dead",[1],1,false);if(name=="black_block"){gameObj.blockArr[gameObj.blockArr.length]=obj;obj.animations.add("out",[2],1,false)}obj.animations.play("live");obj.inputEnabled=true;obj.events.onInputDown.removeAll();obj.events.onInputDown.add(function(){if(obj.floor==gameObj.nextFloor){if(name=="black_block"){if(this.onStartGame&&obj.live){obj.live=false;gameObj.music(gameObj.rdmMusic,this.game);obj.animations.play("dead");obj.scale.set(0.85);this.game.add.tween(obj.scale).to({x:1,y:1},200,null,true,0,0,false);this.clickBlack()}}else{if(name=="white_block"){if(this.onStartGame){gameObj.music(4,this.game);obj.animations.play("dead");this.clickWhite()}}else{if(name=="start_block"){if(!this.onStartGame){gameObj.music(gameObj.rdmMusic,this.game);obj.animations.play("dead");obj.scale.set(0.85);this.game.add.tween(obj.scale).to({x:1,y:1},200,null,true,0,0,false);this.startTime=this.game.time.prevTime;this.onStartGame=true;this.startGame()}}}}gameObj.nextFloor++}},this)};this.addBlock=function(){this.addOneLineBlock(this.blockLine++)};this.addOneLineBlock=function(y){var rdm=this.getRandom(0,3);this.addOneBlock("black_block",rdm,y);for(var i=0;i<4;i++){if(i!=rdm){this.addOneBlock("white_block",i,y)}}};this.startGame=function(){gameObj.score++;var tmpy=this.ground.y+131;this.game.add.tween(this.ground).to({y:tmpy},200,null,true,0,0,false)};this.clickBlack=function(){this.addBlock();gameObj.score++;var gy=this.ground.y;if((gy-526)%131!=0){var gy=(Math.floor((gy-526)/131)+1)*131+526}var tmpy=gy+131;this.game.add.tween(this.ground).to({y:tmpy},200,null,true,0,0,false)};this.clickWhite=function(){this.game.paused=true;gameObj.music(4,this.game);setTimeout(function(){gameObj.game.paused=false;gameObj.gameResult=true;gameObj.gameScore=gameObj.score;gameObj.game.state.start("gameover")},200)};this.getRandom=function(a,b){return Math.floor(Math.random()*(b+1))+a}};gameObj.State_gameover=function(){this.preload=function(){if(gameObj.gameResult){this.game.stage.backgroundColor="#53D769"}else{this.game.stage.backgroundColor="#FC3E39"}};this.create=function(){this.label_mode=this.game.add.text(gameObj.gameWidth/2,115,gameObj.gameMode,{font:"45px 黑体 ",fill:"#fff"});this.label_mode.anchor.set(0.5);if(gameObj.gameResult){this.label_score=this.game.add.text(gameObj.gameWidth/2,235,gameObj.gameScore,{font:"55px Arial ",fill:"#000"});this.label_score.anchor.set(0.5);var tmp=localStorage.getItem("gameData_"+gameObj.gameModeCode);if(gameObj.gameMode=="经典模式"){if(tmp>gameObj.gameScore||tmp==0){this.label_jl=this.game.add.text(gameObj.gameWidth/2,300,"新纪录",{font:"40px Arial ",fill:"#f00"});this.label_jl.anchor.set(0.5);localStorage.setItem("gameData_"+gameObj.gameModeCode,gameObj.gameScore)}}else{if(tmp<gameObj.gameScore){this.label_jl=this.game.add.text(gameObj.gameWidth/2,300,"新纪录",{font:"40px Arial ",fill:"#f00"});this.label_jl.anchor.set(0.5);localStorage.setItem("gameData_"+gameObj.gameModeCode,gameObj.gameScore)}}}else{gameObj.gameScore=0;this.label_score=this.game.add.text(gameObj.gameWidth/2,235,"失败了",{font:"55px Arial ",fill:"#000"});this.label_score.anchor.set(0.5)}this.label_home=this.game.add.text(gameObj.gameWidth/2-50,410,"返回",{font:"35px Arial ",fill:"#fff"});this.label_home.anchor.set(0.5);this.label_home.inputEnabled=true;this.label_home.events.onInputDown.add(function(){gameObj.game.state.start("homepage")},this);this.label_restart=this.game.add.text(gameObj.gameWidth/2+50,410,"重玩",{font:"35px Arial ",fill:"#fff"});
this.label_restart.anchor.set(0.5);this.label_restart.inputEnabled=true;this.label_restart.events.onInputDown.add(function(){gameObj.game.state.start(gameObj.gameModeCode)},this)}};gameObj.game.state.add("boot",gameObj.State_boot);gameObj.game.state.add("preload",gameObj.State_preload);gameObj.game.state.add("homepage",gameObj.State_homepage);gameObj.game.state.add("showrank",gameObj.State_showrank);gameObj.game.state.add("classic",gameObj.State_classic);gameObj.game.state.add("arcade",gameObj.State_arcade);gameObj.game.state.add("zen",gameObj.State_zen);gameObj.game.state.add("relay",gameObj.State_relay);gameObj.game.state.add("gameover",gameObj.State_gameover);gameObj.game.state.start("boot");